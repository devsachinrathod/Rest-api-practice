<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dot Battle 2.0 â€” WebSocket Game</title>
</head>
<body style="height:100%; margin:0; background:#111; color:#eee; font-family:'Segoe UI', sans-serif; overflow:hidden;">

  <!-- HUD -->
  <div id="hud" style="text-align:center; margin:10px auto; font-size:16px; font-weight:bold; color:#0ff; text-shadow:0 0 5px #0ff;">
    Use arrow keys or WASD to move | Tag players to score!
  </div>

  <!-- Game Canvas -->
  <canvas id="game" width="800" height="500" 
    style="display:block; margin:20px auto; background:linear-gradient(145deg,#1b1b1b,#2a2a2a); border:3px solid #444; box-shadow:0 0 20px #0ff inset; border-radius:12px;">
  </canvas>

  <!-- Chat Box -->
  <div id="chatBox" style="width:800px; margin:10px auto; border:2px solid #333; border-radius:8px; background:#1c1c1c; overflow:hidden; box-shadow:0 0 15px #0ff;">
    <div id="chat" style="width:100%; height:120px; background:#000; color:#0f0; overflow-y:auto; font-size:14px; padding:8px; border-bottom:2px solid #333; box-sizing:border-box;"></div>
    <input id="input" placeholder="Type message and press Enter..." 
      style="width:100%; padding:8px; font-size:14px; border:none; outline:none; box-sizing:border-box; background:#111; color:#0ff;"
      onfocus="this.style.background='#222'" onblur="this.style.background='#111'"/>
  </div>

  <!-- Camera Feed -->
  <video id="camera" autoplay muted playsinline 
    style="position:absolute; top:10px; right:10px; width:220px; height:160px; border:2px solid #0ff; border-radius:8px; box-shadow:0 0 20px #0ff; z-index:10;">
  </video>

  <script>
    const ws = new WebSocket("ws://localhost:3000");
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const chatDiv = document.getElementById("chat");
    const chatInput = document.getElementById("input");
    const speed = 3;
    let id = null;
    const players = new Map();
    const keys = {};

    ws.onopen = () => addChat(" Connected to server");
    ws.onclose = () => addChat(" Disconnected");

    ws.onmessage = (ev) => {
      const msg = JSON.parse(ev.data);
      if (msg.type === "welcome") id = msg.id;
      if (msg.type === "world") {
        players.clear();
        msg.players.forEach(p => players.set(p.id, p));
      }
      if (msg.type === "chat") addChat(msg.from + ": " + msg.text);
      if (msg.type === "tag") addChat("ðŸ’€ New tagger: " + msg.tagger);
    };

    function addChat(txt) {
      const el = document.createElement("div");
      el.textContent = txt;
      chatDiv.appendChild(el);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    // Camera streaming
    const camera = document.getElementById("camera");
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => camera.srcObject = stream)
      .catch(err => console.error("Cannot access camera:", err));

    chatInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && chatInput.value.trim() && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "chat", text: chatInput.value.trim() }));
        chatInput.value = "";
      }
    });

    window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
    window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

    function update() {
      let dx = 0, dy = 0;
      if (keys["arrowup"] || keys["w"]) dy -= speed;
      if (keys["arrowdown"] || keys["s"]) dy += speed;
      if (keys["arrowleft"] || keys["a"]) dx -= speed;
      if (keys["arrowright"] || keys["d"]) dx += speed;
      if (dx || dy) ws.send(JSON.stringify({ type: "move", dx, dy }));
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#0a0a0a";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      for (const [pid, p] of players) {
        const x = p.x * (canvas.width / 1000);
        const y = p.y * (canvas.height / 1000);
        ctx.beginPath();
        ctx.arc(x, y, 12, 0, Math.PI * 2);
        ctx.fillStyle = p.color;
        ctx.fill();
        if (p.isTagger) { ctx.lineWidth = 3; ctx.strokeStyle = "#ff4444"; ctx.stroke(); }
        if (pid === id) { ctx.lineWidth = 3; ctx.strokeStyle = "#ffffff"; ctx.stroke(); }
        ctx.fillStyle = "#fff";
        ctx.font = "12px sans-serif";
        ctx.fillText(p.score || 0, x - 4, y - 15);
      }
    }

    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>
</html>
